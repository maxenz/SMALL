/********** GetRubros **********/ 

CREATE PROCEDURE [SMALL].[GetRubros]
AS

    SELECT ID,Descripcion
    FROM SMALL.Rubro
GO


/********** GetNewPublicacionNumber **********/ 

CREATE PROCEDURE [SMALL].[GetNewPublicacionNumber]
AS

	SELECT TOP 1 ID FROM SMALL.Publicacion 
	ORDER BY ID DESC
GO


/********** GetEstadosPublicacion **********/ 

CREATE PROCEDURE [SMALL].[GetEstadosPublicacion]
AS

	SELECT * FROM SMALL.Estado_Publicacion
	ORDER BY ID
GO


/********** GetEstadoPublicacion **********/ 

CREATE PROCEDURE [SMALL].[GetEstadoPublicacion]
@id INT = 0
AS

	SELECT * FROM SMALL.Estado_Publicacion
	WHERE ID = @id
	ORDER BY ID
GO

/********** GetPublicacion **********/ 

CREATE PROCEDURE [SMALL].[GetPublicacion]
@id INT = 0
AS

	SELECT * FROM SMALL.Publicacion
	WHERE ID = @id
	ORDER BY ID
GO

/********** GetTiposPublicacion **********/ 

CREATE PROCEDURE [SMALL].[GetTiposPublicacion]
AS

	SELECT * FROM SMALL.Tipo_Publicacion
	ORDER BY ID
GO


/********** GetTipoPublicacion **********/ 

CREATE PROCEDURE [SMALL].[GetTipoPublicacion]
@id INT = 0
AS

	SELECT * FROM SMALL.Tipo_Publicacion
	WHERE ID = @id
	ORDER BY ID
GO


/********** GetPublicaciones **********/ 

CREATE PROCEDURE [SMALL].[GetPublicaciones]
AS

	SELECT TOP(200) * FROM SMALL.Publicacion
	ORDER BY ID
GO

/********** GetRubrosFromPublicacion **********/ 

CREATE PROCEDURE [SMALL].[GetRubrosFromPublicacion]
@id INT = 0
AS

	SELECT rub.ID,rub.Descripcion FROM SMALL.Rubro rub
    LEFT JOIN SMALL.Publicacion_Rubro pubrub ON(rub.ID = pubrub.ID_Rubro) 
    WHERE pubrub.ID_Publicacion = @id
    ORDER BY rub.ID
GO

/********** GetPersonas **********/ 

CREATE PROCEDURE [SMALL].[GetPersonas]
AS

	SELECT * FROM SMALL.Persona per
	LEFT JOIN SMALL.Cliente cli ON (cli.ID_Persona = per.ID)
	LEFT JOIN SMALL.Empresa emp ON (emp.ID_Persona = per.ID)
	ORDER BY ID
GO

/********** GetLastPublicacionFacturada **********/ 

CREATE PROCEDURE [SMALL].[GetLastPublicacionFacturada]
@idPersona INT = 0
AS

	SELECT TOP 1 fac.ID as ID_Factura,itm.ID_Publicacion, pub.Fecha_Vencimiento
	FROM SMALL.Item_Factura itm
	LEFT JOIN SMALL.Factura fac ON (fac.ID = itm.ID_Venta)
	LEFT JOIN SMALL.Publicacion pub ON (itm.ID_Publicacion = pub.ID)
	WHERE fac.ID_Persona = @idPersona
	GROUP BY fac.ID, itm.ID_Publicacion, pub.Fecha_Vencimiento
	ORDER BY pub.Fecha_Vencimiento DESC

GO

/********** GetPublicacionesAFacturar **********/ 

CREATE PROCEDURE [SMALL].[GetPublicacionesAFacturar]
@cantAFacturar INT, @fechaUltimaFacturada VARCHAR(100), @idPersona INT
AS

	SELECT TOP (@cantAFacturar) * FROM small.PUBLICACION
	WHERE Fecha_Vencimiento > @fechaUltimaFacturada
	 AND ID_Estado = 3
	 AND ID_Persona_Venta = @idPersona
	ORDER BY Fecha_Vencimiento ASC
GO